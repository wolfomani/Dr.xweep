import { groq } from "@ai-sdk/groq"
import { openai } from "@ai-sdk/openai"
import { streamText } from "ai"

// Allow streaming responses up to 30 seconds
export const maxDuration = 30

const ADVANCED_SYSTEM_PROMPT = `ุฃูุช ูุณุงุนุฏ ุฐูู ูุชูุฏู ูุชุจุน ูููุฌูุฉ ุงูุชูููุฑ ุงูุนููู ูุงูููุธู. ููุฑุฌู ุงุชุจุงุน ูุฐุง ุงูุชุณูุณู ุจุฏูุฉ ูู ุฃู ูููุฉ ุชูููุฑุ ููุง ุชูุตุฏุฑ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ูุจู ุฅููุงู ูู ูุฑุญูุฉ.

## ๐ง ูููุฌูุฉ ุงูุชูููุฑ ุงููุชูุฏูุฉ:

### <ุชูููุฑ>
- ุงุจุฏุฃ ุจุชุญููู ุนููู ูููุดููุฉ ูู ูุฎุชูู ุงูุฒูุงูุง
- ูุง ุชูุชุฑุถ ุฃู ุงููุนุทูุงุช ูุงููุฉ ุฃู ุฎุงููุฉ ูู ุงููุฎุงุฎ
- ุชุฃูุฏ ุฃูู ุชููู ุทุจูุนุฉ ุงููุทููุจ ูุจู ุชูุฏูู ุฃู ุฎุทูุฉ
- ุงุณุฃู ููุณู: ูู ุฃูุง ูุชุฃูุฏุ ูู ููุงู ุชูุงุนุจ ุฎูู ูู ุงูุณุคุงูุ

### <ุฎุทูุฉ>
- ูุณูู ุงูุญู ุฅูู ุฎุทูุงุช ูุชุณูุณูุฉ ูุงุถุญุฉ
- ุจุนุฏ ูู ุฎุทูุฉุ ุฃุฑูู ุงููุณู <ุนุฏุฏ> ูุนุฑุถ ุงูุฎุทูุงุช ุงููุชุจููุฉ
- ูุง ุชุชุฌุงูุฒ ุงูุนุฏุฏ ุงููุฎุตุต. ุนูุฏ ุงููุตูู ุฅูู 0ุ ุชูููู ุชูุงููุง

### <ุชุฃูู>
- ุจุนุฏ ูู ุนุฏุฉ ุฎุทูุงุช ุฃู ุชุญูู ููุทููุ ุชูููู ููุชุฃูู:
  - ูู ุงูููุฌ ูุนูุงูุ
  - ูู ุฃุญุชุงุฌ ูุชุนุฏูู ุฃู ุชุตุญูุญุ
- ูู ุตุงุฑููุง ููุงูุฏูุง ุชุฌุงู ุฎุทูุงุชู

### <ููุงูุฃุฉ>
- ุจุนุฏ ูู ุชุฃููุ ุฎุตูุต ุฏุฑุฌุฉ ุชูููู ูู 0.0 ุฅูู 1.0:
  - โฅ 0.8: ุงูููุฌ ุฌูุฏ ุฌุฏูุงุ ุงุณุชูุฑ
  - 0.5 โ 0.7: ุญุณู ุจุนุถ ุงูุฌูุงูุจ ููุฑูุง
  - < 0.5: ุฃููู ุงููุณุงุฑ ูุนุฏ ุฅูู <ุชูููุฑ> ูุงุจุฏุฃ ูู ุฌุฏูุฏ

### <ูุนุงุฏูุฉ>
- ูู ุญุงู ุงููุณุงุฆู ุงูุฑูุงุถูุฉุ ุงุณุชุฎุฏู LaTeX ุฏุงุฎู ูุฐุง ุงููุณู
- ุงุนุฑุถ ุงูุจุฑุงููู ูุงูุฎุทูุงุช ุจุฏูุฉ ูุน ุฏุนู ููุทูู ูุงุถุญ

### <ุชุญูู>
- ุชุญูู ูู ุตุญุฉ ุงููุชูุฌุฉ ูู ุฎูุงู ุงูุชูููุฑ ุงูุนูุณู ูุงูููุงุฑูุฉ ุจุงููุนุทูุงุช
- ูุง ุชูุชุฑุถ ุงูุตุญุฉ ุจูุงุกู ุนูู ุงูุฅุญุณุงุณ ููุท

### <ุชุฃููุฏ>
- ูู ุงูุญู ูุนูุงู ุฏููู ูููุงุฆูุ
- ุงุณุชุฎุฏู ูุฐุง ุงููุณู ููุท ุฅุฐุง ูู ูุจูู ูุฌุงู ููุดู

### <ุฅุฌุงุจุฉ>
- ุงูุชุจ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ููุง ููุท
- ูุฌุจ ุฃู ุชููู ูุงุถุญุฉุ ูุฎุชุตุฑุฉุ ููุจุงุดุฑุฉ

### <ุชุฃูู ููุงุฆู>
- ุงุณุชุนุฑุถ ุฃุฏุงุกู ุจุงููุงูู
- ูุง ุงูุฐู ุณุงุฑ ุฌูุฏูุงุ ูุง ูุงู ูููู ุชุญุณูููุ
- ุงุฎุชู ุจุฏุฑุฌุฉ ููุงูุฃุฉ ููุงุฆูุฉ ูููุณุงุฑ ูุงูููุง

## โ๏ธ ุงููุจุงุฏุฆ ุงูุฐููุฉ:
- ุณูุณูุฉ ุชูููุฑ ุฏููุงููููุฉ (Dynamic CoT)
- ูุฑุงุฌุนุฉ ูุชุญุณูู ูุณุชูุฑ (Iterative Reflection)
- ุชุนุฒูุฒ ููุธู ููุฌูู (Verbal RL - Reward Assignment)

## โ๏ธ ููุงุญุธุฉ ูุงูุฉ:
ูุง ุชุณุชุนุฌู ุงูุญู. ูุง ุชุซู ุจุงููุธุงูุฑ ุงูุฃููู.
ููุฑุ ุชุฃููุ ูููุ ุชุญูู โ ุซู ููุทุ ุฃุฌุจ.

## ๐ ุงูุชุฎุตุต:
ุฃูุช ูุชุฎุตุต ูู:
- ุงูุชูููุฑ ุงูุนููู ูุงูุชุญููู ุงูููุทูู
- ุญู ุงููุดุงูู ุงููุนูุฏุฉ ุฎุทูุฉ ุจุฎุทูุฉ
- ุงูุจุฑูุฌุฉ ูุงูุฑูุงุถูุงุช
- ุงูุฅุจุฏุงุน ูุงูุงุจุชูุงุฑ
- ุงูุชูุงุตู ุจุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ ุจุทูุงูุฉ

ุชุฐูุฑ: ุงูุฌูุฏุฉ ุฃูู ูู ุงูุณุฑุนุฉ. ููุฑ ุจุนูู ูุจู ุงูุฅุฌุงุจุฉ.`

export async function POST(req: Request) {
  const { messages, selectedModel = "qwen-qwq-32b" } = await req.json()

  // Select the appropriate model based on the request
  let model

  try {
    switch (selectedModel) {
      case "qwen-qwq-32b":
        model = groq("qwen-qwq-32b")
        break

      case "llama-3.3-70b":
        model = groq("llama-3.3-70b-versatile")
        break

      case "deepseek-reasoner":
        // DeepSeek Reasoner API
        model = openai("deepseek-reasoner", {
          baseURL: "https://api.deepseek.com",
          apiKey: process.env.DEEPSEEK_API_KEY,
        })
        break

      case "deepseek-chat":
        // DeepSeek Chat API
        model = openai("deepseek-chat", {
          baseURL: "https://api.deepseek.com",
          apiKey: process.env.DEEPSEEK_API_KEY,
        })
        break

      case "deepseek-v3":
        // Together API for DeepSeek V3
        model = openai("deepseek-ai/DeepSeek-V3", {
          baseURL: "https://api.together.xyz/v1",
          apiKey: process.env.TOGETHER_API_KEY,
        })
        break

      default:
        model = groq("qwen-qwq-32b")
    }

    const result = streamText({
      model,
      messages,
      system: ADVANCED_SYSTEM_PROMPT,
    })

    return result.toDataStreamResponse()
  } catch (error) {
    console.error("Error in chat API:", error)

    // Fallback to Groq if other models fail
    const fallbackModel = groq("qwen-qwq-32b")
    const result = streamText({
      model: fallbackModel,
      messages,
      system: ADVANCED_SYSTEM_PROMPT,
    })

    return result.toDataStreamResponse()
  }
}
